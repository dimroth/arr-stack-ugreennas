# Source Tree Analysis

> Generated by Document Project workflow on 2026-02-19

## Project Root Structure

```
arr-stack-ugreennas/
├── docker-compose.traefik.yml        # [INFRA] Traefik v3 reverse proxy + network creation
├── docker-compose.arr-stack.yml      # [APP]   Main media stack (27+ services, 26.5KB)
├── docker-compose.utilities.yml      # [OPT]   Monitoring & utilities (8 services)
├── docker-compose.cloudflared.yml    # [INFRA] Cloudflare Tunnel for external access
├── docker-compose.plex-arr-stack.yml # [ALT]   Plex variant of main stack (untested)
│
├── .env.example                      # Environment template (9.3KB, organized by setup level)
├── .env                              # ⛔ Actual credentials (gitignored)
├── config.local.md                   # ⛔ Private NAS config: hostname, IPs, username (gitignored)
├── config.local.md.example           # Template for private config
│
├── README.md                         # Project overview, feature list, getting started
├── CONTRIBUTING.md                   # Architecture, pre-commit hooks, release process
├── CLAUDE.md                         # AI assistant instructions (deployed to NAS)
├── CHANGELOG.md                      # Version history
├── .gitignore                        # 107-line exclude patterns
├── .gitmodules                       # BATS test framework submodules
│
├── traefik/                          # Reverse proxy configuration
│   ├── traefik.yml.example           # Static config template
│   ├── traefik.yml                   # ⛔ User config (gitignored)
│   ├── acme.json                     # ⛔ SSL certificates (gitignored)
│   └── dynamic/                      # Dynamic routing rules
│       ├── vpn-services.yml.example  # Jellyfin routing template
│       ├── vpn-services-plex.yml.example # Plex routing template
│       ├── vpn-services.yml          # ⛔ User routing config (gitignored)
│       ├── local-services.yml        # .lan domain routes (tracked)
│       ├── utilities.yml             # Utilities routing (tracked)
│       ├── tls.yml                   # TLS/SSL settings (tracked)
│       └── *.local.yml               # ⛔ User custom routes (gitignored)
│
├── cloudflared/                      # Cloudflare Tunnel
│   ├── config.yml.example            # Tunnel config template
│   ├── config.yml                    # ⛔ User tunnel config (gitignored)
│   ├── credentials.json              # ⛔ Tunnel credentials (gitignored)
│   └── cert.pem                      # ⛔ Certificate (gitignored)
│
├── pihole/                           # DNS & DHCP configuration
│   ├── 02-local-dns.conf.example     # .lan domain template (15 domains)
│   └── 02-local-dns.conf             # ⛔ User DNS config (gitignored)
│
├── recyclarr/                        # TRaSH Guide sync
│   ├── recyclarr.yml                 # Quality profile config (tracked)
│   └── secrets.yml.example           # API keys template
│
├── mosquitto/                        # MQTT broker for TeslaMate
│   └── mosquitto.conf                # Minimal config (anonymous, port 1883)
│
├── scripts/                          # Automation & validation
│   ├── pre-commit                    # ★ Main pre-commit hook (11 checks)
│   ├── setup-hooks.sh                # Install pre-commit hooks
│   ├── restart-stack.sh              # Safe stack restart (force-recreate)
│   ├── backup-volumes.sh             # ★ Volume backup automation (11KB)
│   ├── arr-backup.sh                 # Arr app backup helper
│   ├── check-network.sh              # Network diagnostics
│   ├── check-dns-duplicates.sh       # DNS validation
│   ├── lib/                          # Pre-commit check modules
│   │   ├── common.sh                 # ★ Shared functions: SSH, NAS config, file scanning
│   │   ├── check-secrets.sh          # Detects API keys, passwords, bcrypt hashes
│   │   ├── check-env-vars.sh         # Ensures ${VAR} refs documented in .env.example
│   │   ├── check-yaml-syntax.sh      # YAML validation with PyYAML fallback
│   │   ├── check-conflicts.sh        # Port/IP conflict detection
│   │   ├── check-compose-drift.sh    # Jellyfin/Plex variant consistency
│   │   ├── check-hardcoded-domain.sh # Domain/hostname leak detection
│   │   ├── check-env-backup.sh       # NAS .env backup sync check
│   │   ├── check-uptime-monitors.sh  # Uptime Kuma monitor sync validation
│   │   ├── check-dns-duplicates.sh   # DNS duplicate detection
│   │   ├── check-domains.sh          # Domain accessibility validation
│   │   └── check-image-versions.sh   # Docker image staleness check (9KB)
│   └── qbit-scheduler/               # Custom Docker image
│       ├── Dockerfile                # qBittorrent pause/resume scheduler
│       ├── entrypoint.sh             # Service entry point
│       └── pause-resume.sh           # Pause/resume logic
│
├── tests/                            # BATS test suite
│   ├── run-tests.sh                  # Test runner
│   ├── compose-validation.bats       # Docker Compose validation tests
│   ├── env-vars.bats                 # Environment variable tests
│   ├── port-conflicts.bats           # Port conflict detection tests
│   ├── pre-commit-checks.bats        # Pre-commit hook tests
│   ├── security.bats                 # Security check tests
│   ├── helpers/
│   │   └── setup.bash                # Test setup utilities
│   ├── fixtures/
│   │   ├── .env.test                 # Test environment
│   │   ├── compose-port-conflict.yml # Port conflict test fixture
│   │   └── compose-with-secrets.yml  # Secret detection test fixture
│   ├── bats-core/                    # BATS framework (git submodule)
│   ├── bats-support/                 # BATS support library (git submodule)
│   └── bats-assert/                  # BATS assertions (git submodule)
│
└── docs/                             # Documentation
    ├── SETUP.md                      # ★ Complete setup guide (54KB)
    ├── ARCHITECTURE.md               # ★ Network topology, service connections
    ├── REFERENCE.md                  # URLs, ports, IPs, common commands
    ├── UPGRADING.md                  # Version upgrade procedures
    ├── BACKUP.md                     # Backup & restore guide
    ├── HOME-ASSISTANT.md             # Home Assistant integration
    ├── TROUBLESHOOTING.md            # Common issues and fixes
    ├── LEGAL.md                      # Legal disclaimer
    ├── images/                       # Documentation images
    │   ├── demo/demo.gif             # Stack demo animation
    │   ├── Surfshark/ (5 PNG)        # VPN setup tutorial images
    │   ├── jellyfin/ (2 PNG)         # Jellyfin config screenshots
    │   └── qbit/ (1 PNG)            # qBittorrent setup screenshot
    └── logos/ (17 SVG/PNG)           # Service logos
```

**Legend:** ★ = key file, ⛔ = gitignored (user-specific)

## Critical Directories

| Directory | Purpose | Key Contents |
|-----------|---------|-------------|
| `/` (root) | Compose files and project config | 5 compose files define all services |
| `traefik/` | Reverse proxy routing | Static + dynamic routing configs with `.example` pattern |
| `traefik/dynamic/` | Service routing rules | Per-service routes, TLS config |
| `cloudflared/` | External access tunnel | Tunnel credentials and wildcard routing |
| `pihole/` | DNS configuration | `.lan` domain definitions |
| `scripts/` | Automation hub | Pre-commit, backup, restart, diagnostics |
| `scripts/lib/` | Pre-commit modules | 11 modular validation checks |
| `tests/` | BATS test suite | 6 test files + fixtures |
| `docs/` | User documentation | 8 guides totaling 100+ KB |

## Entry Points

| Entry Point | Type | Description |
|-------------|------|-------------|
| `docker-compose.traefik.yml` | Deploy first | Creates `arr-stack` and `traefik-lan` networks |
| `docker-compose.arr-stack.yml` | Deploy second | Main application stack |
| `docker-compose.cloudflared.yml` | Deploy third | External access (optional) |
| `docker-compose.utilities.yml` | Deploy last | Monitoring tools (optional) |
| `scripts/pre-commit` | Git hook | Validates commits with 11 checks |
| `scripts/backup-volumes.sh` | Cron job | Daily automated backup at 6am |
| `scripts/restart-stack.sh` | Operations | Safe stack restart wrapper |

## Configuration Pattern

The project uses a **template-and-customize** pattern:

```
*.example (tracked)  →  copy  →  *.yml (gitignored, user-customized)
.env.example (tracked)  →  copy  →  .env (gitignored)
config.local.md.example  →  copy  →  config.local.md (gitignored)
```

This ensures `git pull` updates templates without overwriting user customizations.

## Network Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│ traefik-lan (macvlan - physical LAN presence)                    │
│  Traefik (TRAEFIK_LAN_IP:80) + Pi-hole (PIHOLE_LAN_IP:53/80)  │
│  Tailscale (TAILSCALE_LAN_IP)                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ arr-stack (bridge 172.20.0.0/24 - inter-container routing)       │
│  Traefik(.2) Gluetun(.3) Jellyfin(.4) Pi-hole(.5)              │
│  TeslaMate(.6) TeslaMate-DB(.7) Seerr(.8) Bazarr(.9)           │
│  FlareSolverr(.10) Grafana(.11) Cloudflared(.12)                │
│  Uptime-Kuma(.13) duc(.14) Beszel(.15) Tailscale(.16)          │
│  Mosquitto(.17) Immich(.18) Immich-ML(.19) Immich-PG(.20)      │
│  Immich-Redis(.21) Recyclarr(.22) DIUN(.23)                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ vpn-net (bridge 10.8.1.0/24 - VPN routing)                      │
│  Gluetun + Pi-hole(10.8.1.200)                                  │
└─────────────────────────────────────────────────────────────────┘

VPN services (no own IP - share gluetun's network namespace):
  qBittorrent, SABnzbd, Sonarr, Radarr, Prowlarr, Recyclarr
```

## Storage Architecture

```
NAS Filesystem:
├── /volume1/
│   ├── Media/
│   │   ├── downloads/     # qBittorrent + SABnzbd working directory
│   │   ├── tv/            # Completed TV shows (Sonarr manages)
│   │   └── movies/        # Completed movies (Radarr manages)
│   └── immich/
│       └── upload/        # Immich photo/video storage
│
├── /volume2/
│   └── docker/
│       └── arr-stack/     # Git repo clone (deployment source)
│           ├── traefik/   # Bind-mounted configs
│           ├── cloudflared/
│           ├── pihole/
│           ├── recyclarr/
│           └── mosquitto/
│
└── Docker Named Volumes    # Service data (managed by Docker)
    ├── arr-stack_jellyfin-config
    ├── arr-stack_sonarr-config
    ├── arr-stack_radarr-config
    └── ... (20+ volumes)
```
