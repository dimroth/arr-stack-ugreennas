# Deployment Guide

> Generated by Document Project workflow on 2026-02-19
>
> For step-by-step first-time setup, see [SETUP.md](./SETUP.md).
> This document covers the deployment architecture for AI-assisted development context.

## Deployment Architecture

### Overview

```
Local Machine                  GitHub                    NAS (Production)
─────────────                  ──────                    ────────────────
Edit configs     ──push──►    Repository    ◄──pull──    /volume2/docker/arr-stack/
Run pre-commit                                           docker compose up -d
```

The NAS has a git clone of the repository. Deployment is done via `git pull`, not file copy.

### Deployment Order

Services must be started in this order (networks must exist before services that use them):

| Step | Command | Creates/Starts |
|------|---------|---------------|
| 1 | `docker compose -f docker-compose.traefik.yml up -d` | `arr-stack` + `traefik-lan` networks, Traefik |
| 2 | `docker compose -f docker-compose.cloudflared.yml up -d` | Cloudflare Tunnel |
| 3 | `docker compose -f docker-compose.arr-stack.yml up -d` | All 20+ application services |
| 4 | `docker compose -f docker-compose.utilities.yml up -d` | Monitoring and tools |

### Standard Deploy Procedure

```bash
# 1. Commit and push locally
git add -A && git commit -m "description" && git push

# 2. Pull on NAS
sshpass -f ~/.ssh/.nas_pass ssh user@nas "cd /volume2/docker/arr-stack && git pull"

# 3. Restart affected services
# For compose changes:
sshpass -f ~/.ssh/.nas_pass ssh user@nas "cd /volume2/docker/arr-stack && docker compose -f docker-compose.arr-stack.yml up -d --force-recreate"

# For Traefik routing changes only:
sshpass -f ~/.ssh/.nas_pass ssh user@nas "docker restart traefik"
```

### Critical Safety Rule

**Never use `docker compose down`** on the arr-stack. Pi-hole provides DNS and DHCP for the entire LAN. Stopping it kills network connectivity before `up -d` can run.

```bash
# WRONG - kills DNS, you lose connection
docker compose -f docker-compose.arr-stack.yml down

# RIGHT - atomic restart, Pi-hole back in seconds
docker compose -f docker-compose.arr-stack.yml up -d --force-recreate
```

## Container Image Management

### Image Update Procedure

```bash
# Pull new images and recreate only changed services
docker compose -f docker-compose.arr-stack.yml pull <service>
docker compose -f docker-compose.arr-stack.yml up -d <service>

# Important: restart keeps old image; up -d uses new image
docker restart sonarr        # Uses OLD image
docker compose up -d sonarr  # Uses NEW image (after pull)
```

### Automated Image Monitoring

UGOS handles automatic updates natively:
- Docker Management > Image update > enabled
- Schedule: weekly

DIUN (Docker Image Update Notifier) sends Telegram notifications when newer images are available.

### Image Version Pinning

Most services pin specific versions in compose files:
```yaml
image: lscr.io/linuxserver/sonarr:4.0.16      # Pinned
image: ghcr.io/seerr-team/seerr:latest         # Floating
image: tailscale/tailscale:latest               # Floating
```

## Environment Configuration

### Required Files on NAS

| File | Source | Purpose |
|------|--------|---------|
| `.env` | Manual (from `.env.example`) | All credentials and configuration |
| `traefik/traefik.yml` | Manual (from `traefik.yml.example`) | Traefik static config |
| `traefik/dynamic/vpn-services.yml` | Manual (from `vpn-services.yml.example`) | Service routing |
| `cloudflared/config.yml` | Manual (from `config.yml.example`) | Tunnel routing |
| `cloudflared/credentials.json` | `cloudflared tunnel create` | Tunnel credentials |
| `pihole/02-local-dns.conf` | Manual (from `02-local-dns.conf.example`) | DNS entries |
| `recyclarr/secrets.yml` | Manual (from `secrets.yml.example`) | API keys |

### Setup Levels

The `.env` is organized by setup level. Each level adds variables:

1. **Core**: `MEDIA_ROOT`, `TZ`, `PUID/PGID`, VPN credentials
2. **+ Local DNS**: `NAS_IP`, `PIHOLE_UI_PASS`, `TRAEFIK_LAN_IP/MAC`, `PIHOLE_LAN_IP/MAC`, `LAN_INTERFACE`, `LAN_SUBNET`, `LAN_GATEWAY`
3. **+ Remote Access**: `DOMAIN`, `TRAEFIK_DASHBOARD_AUTH`
4. **+ Tailscale**: `TS_AUTHKEY`, `TAILSCALE_LAN_IP`
5. **+ TeslaMate**: `TESLAMATE_ENCRYPTION_KEY`, `TESLAMATE_DB_PASS`
6. **+ Immich**: `IMMICH_VERSION`, `IMMICH_DB_PASSWORD`
7. **Utilities**: `QBIT_USER/PASSWORD`, `BESZEL_KEY`, `DIUN_TELEGRAM_*`

## Backup and Recovery

### Automated Backup

- **Schedule**: Daily at 6am via cron
- **Script**: `scripts/backup-volumes.sh --tar /mnt/arr-backup`
- **Output**: ~13MB compressed tarball
- **Retention**: 7 days on USB
- **Safety**: EXIT trap ensures services keep running on failure

### Backup Scope

**Included** (~60MB uncompressed, ~13MB compressed):
gluetun-config, qbittorrent-config, sabnzbd-config, prowlarr-config, bazarr-config, uptime-kuma-data, pihole-etc-dnsmasq, seerr-config, tailscale-state, recyclarr-config

**Excluded** (regeneratable):
jellyfin-config (407MB), sonarr-config (43MB), radarr-config (110MB), pihole-etc-pihole (138MB), jellyfin-cache (43MB)

### Emergency Recovery (Pi-hole Down)

1. Connect to mobile hotspot
2. SSH to NAS using IP address (not hostname)
3. `cd /volume2/docker/arr-stack && docker compose -f docker-compose.arr-stack.yml up -d`
4. Wait 30 seconds, reconnect to home WiFi

## Network Requirements

### Docker Networks (Created by Traefik Compose)

| Network | Type | Subnet | Purpose |
|---------|------|--------|---------|
| arr-stack | bridge | 172.20.0.0/24 | Inter-container communication |
| traefik-lan | macvlan | LAN subnet | Physical LAN presence |
| vpn-net | bridge | 10.8.1.0/24 | Internal VPN routing |

### Port Mappings (Host → Container)

| Port | Service | Compose File |
|------|---------|-------------|
| 9090 | Traefik Dashboard | traefik.yml |
| 8096 | Jellyfin | arr-stack.yml |
| 8989 | Sonarr (via Gluetun) | arr-stack.yml |
| 7878 | Radarr (via Gluetun) | arr-stack.yml |
| 9696 | Prowlarr (via Gluetun) | arr-stack.yml |
| 8085 | qBittorrent (via Gluetun) | arr-stack.yml |
| 8082 | SABnzbd (via Gluetun) | arr-stack.yml |
| 5055 | Seerr | arr-stack.yml |
| 6767 | Bazarr | arr-stack.yml |
| 4000 | TeslaMate | arr-stack.yml |
| 3100 | Grafana (TeslaMate) | arr-stack.yml |
| 2283 | Immich | arr-stack.yml |
| 3001 | Uptime Kuma | utilities.yml |
| 8838 | duc | utilities.yml |
| 8090 | Beszel | utilities.yml |

### External Access

- **Cloudflare Tunnel**: Routes `*.yourdomain.com` → `NAS_IP:8080` (Traefik)
- **Traefik**: Routes by Host header to correct container
- **Publicly exposed**: Jellyfin, Seerr, Traefik dashboard (with auth), Immich
- **LAN-only**: All admin UIs (Sonarr, Radarr, Prowlarr, qBittorrent, Pi-hole, etc.)

## Hardware Requirements

| Component | Minimum | Recommended |
|-----------|---------|-------------|
| RAM | 4GB | 8GB+ |
| CPU | Any Docker-capable | Intel N100+ (for Quick Sync transcoding) |
| Storage | Depends on media | Multiple volumes recommended |
| GPU | None (software transcode) | Intel GPU (hardware transcode) |

### Intel Quick Sync (Hardware Transcoding)

Jellyfin and Immich use Intel Quick Sync for hardware-accelerated video transcoding:
```yaml
devices:
  - /dev/dri:/dev/dri
group_add:
  - "${RENDER_GROUP_ID:-0}"
```
Remove these 4 lines from compose if no Intel GPU is present.
